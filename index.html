<!DOCTYPE html>
<html lang="en">
<head>

  <!-- Basic Page Needs
  –––––––––––––––––––––––––––––––––––––––––––––––––– -->
  <meta charset="utf-8">
  <title>Todos App</title>
  <meta name="description" content="">
  <meta name="author" content="">

  <!-- Mobile Specific Metas
  –––––––––––––––––––––––––––––––––––––––––––––––––– -->
  <meta name="viewport" content="width=device-width, initial-scale=1">

  <!-- FONT
  –––––––––––––––––––––––––––––––––––––––––––––––––– -->
  <link href="//fonts.googleapis.com/css?family=Raleway:400,300,600" rel="stylesheet" type="text/css">

  <!-- CSS
  –––––––––––––––––––––––––––––––––––––––––––––––––– -->
  <link rel="stylesheet" href="css/normalize.css">
  <link rel="stylesheet" href="css/skeleton.css">
  <link rel="stylesheet" href="css/todos.css">

  <!-- Favicon
  –––––––––––––––––––––––––––––––––––––––––––––––––– -->
  <link rel="icon" type="image/png" href="images/favicon.png">

</head>
<body>

  <!-- Primary Page Layout
  –––––––––––––––––––––––––––––––––––––––––––––––––– -->
  <div class="container">
    <div class="row">
      <div class="one-half column" style="margin-top: 5%">
        <h2>todo<strong>list</strong></h2>
        <input id="todo-input" class="u-full-width" type="text" placeholder="I just want to have something to do">
        <ul id="todos-list"></ul>
      </div>
    </div>
  </div>

<script src="https://code.jquery.com/jquery-3.3.1.min.js"
  integrity="sha256-FgpCb/KJQlLNfOu91ta32o/NMZxltwRo8QtmkMRdAu8="
  crossorigin="anonymous"></script>
<script>
  $(document).ready(function() {

    $.getJSON("/api/todos")
    .then(addTodos);

    $('#todo-input').keypress(function(event){
      // create todo when we press enter (code 13)
      if (event.which == 13) {
        createTodo();
        // clear the input after creating todo
        $('#todo-input').val('');
      }
    });

    $('#todos-list').on('click', 'span', function(e) {
      e.stopPropagation();
      removeTodo($(this).parent());
    });

    $('#todos-list').on('click', 'li', function() {
      updateTodo($(this));
    });

  });

  function addTodos(todos) {
      todos.forEach(function(todo) {
        addTodo(todo);
      });
  }

  function addTodo(todo) {
    var todoItem = $('<li>' + todo.name + '<span class="u-pull-right">✖</span></li>');
    todoItem.data('id', todo._id);
    todoItem.data('completed', todo.completed);
    if (todo.completed) { todoItem.addClass("completed"); }
    $('#todos-list').append(todoItem);
  }

  function createTodo() {
    //get the value of the user input
    var userInput = $('#todo-input').val();
    // post the todo to the API (and save in the db)
    $.post('/api/todos', {name: userInput})
    .then(function(newTodo) {
      // display the todo in the DOM
      addTodo(newTodo);
    })
    .catch(function(error) {
      console.log(error)
    });
  }

  function removeTodo(todo) {
    var clickedId = todo.data('id');
    console.log('trying to delete post with id: ' + todo.data('id'));
    var urlToDelete = '/api/todos/' + clickedId;
    // AJAX call to the API in order to remove from db
    $.ajax({
      method: 'DELETE',
      url: urlToDelete
    })
    .then(function(serverMessage) {
      console.log(serverMessage);
    })
    .then(function() {
      // remove from the DOM
      todo.remove();
    })
    .catch(function(error) {
      console.log(error)
    });
  }


  function updateTodo(todo) {
    console.log(todo.data('completed'));
    var clickedId = todo.data('id');
    console.log('trying to update todo with id: ' + clickedId);
    var urlToUpdate = '/api/todos/' + clickedId;
    // AJAX call to the API in order to update in db
    // send data with the completed property toggled
    $.ajax({
      method: 'PUT',
      url: urlToUpdate,
      data: { completed: !(todo.data('completed')) }
    })
    .then(function(serverMessage) {
      console.log(serverMessage);
    })
    .then(function() {
      // update the DOM conditionally in order to display the toggled state
      todo.data('completed') ? todo.removeClass("completed") : todo.addClass("completed")
      // update the todo.data('completed') so that consecutive toggles can be performed
      todo.data('completed', !todo.data('completed'));
    })
    .catch(function(error) {
      console.log(error)
    });
  }

</script>


<!-- End Document
  –––––––––––––––––––––––––––––––––––––––––––––––––– -->
</body>
</html>
